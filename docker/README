Using docker for testing
========================

This file describes how to perform testing of the agent using docker
and a test runner/management script called "packnsend".

Initial setup of docker
-----------------------

You need to have a docker service running somewhere. If this is not on your
local host, then you need to at least have the docker client available in
your PATH and the 'DOCKER_HOST' environment variable set to the name of the
docker service host.

Running docker on MacOS X
-------------------------

The docker service cannot be run natively on MacOS X. Instead you need
to run it under VirtualBox. Make sure you have up to date VirtualBox
installed.

The procedure documented on docker.io for actually now running docker also
involves using Vagrant, but there is a simpler way using a tool called
boot2docker.

The boot2docker project can be found at:

* https://github.com/steeve/boot2docker

Skip the initial instructions and follow the instructions for MacOS X in
that page at, but first read the note below.

* https://github.com/steeve/boot2docker#init-script-osx-and-linux

Note that if you are using a New Relic managed MacBook, then CrashPlan
runs on the same port as the docker service wants to use. As a result you
will need to override what port the docker service is exported on from
the virtual machine.

To do this, before even running boot2docker, you need to create in your
home directory a subdirectory called '.boot2docker' and create within that
the file 'profile'. In that file add:

    DOCKER_PORT=14243

    VM_DISK=$HOME/.boot2docker/boot2docker.vmdk
    BOOT2DOCKER_ISO=$HOME/.boot2docker/boot2docker.iso

Even if not needing to override the docker service port, set the locations
for the boot2docker VM image and ISO so they are located in this directory
also.

Now follow the steps to create the boot2docker instance. Copying the
boot2docker script into your PATH somewhere. A good idea might be to
actually copy it into $HOME/.boot2docker as well and then add:

    export PATH="$HOME/.boot2docker:$PATH"

into your .bash_profile script.

Once you have boot2docker running you need the MacOS X binary for the docker
client. You can download it from the docker site, ensuring you make it
executable.

    wget https://get.docker.io/builds/Darwin/x86_64/docker-latest -O docker
    chmod +x docker

This also can be placed into $HOME/.boot2docker if you added that directory
to PATH.

Before using it or the 'packnsend' script, you need to set and export
DOCKER_HOST environment variable to 'localhost'.

    export DOCKER_HOST="localhost"

If you had to override the docker service port however, include the port
as part of the DOCKER_HOST environment variable:

    export DOCKER_HOST="localhost:14243"

Set this permanently in your .bash_profile as well.

To test it works run:

    docker version

Setting up a Quay.io Account
----------------------------

Quay.io is a private docker repository where we store the docker images that
we use for testing. Only authorized quay.io users have access to the images.
Since, pulling the images from quay.io is typically faster than building them
from the Dockerfiles, it's worth setting up an account.

Account setup steps:

1. Create a quay.io account at https://quay.io. Use your newrelic.com email
address.

2. Have someone with admin rights on the quay.io account add you to the
python team on quay.io, which is a sub-group of the newrelic organization.
(Currently, Tom Offermann is the admin for the Python team.) You should get
permissions to pull from the repo, push to the repo, and create new repos.

3. Login to your quay.io account from the command line:

    docker login quay.io

You will be prompted to enter your quay.io username, password, and email
address. Once you do that, you will be logged in, and a .dockercfg file
will be created and installed automatically for you. This file stores your
login credentials, so you do not have to run `docker login` every time you
want to access the images hosted on quay.io.

Using Quay.io on Jenkins
------------------------

There is a special "Robot account" set up for use by Jenkins to pull images
from quay.io. The account name is 'newrelic+pythonagentbot'.

To get the the login credentials for the Robot account, someone with admin
rights on the quay.io account needs to download the .dockercfg file from the
quay.io web site.

Using Packnsend
===============

The "packnsend" script simplifies the management of a set of base docker
image and the running of tests in a docker container. The workflow consists
of:

1. Pull or build the base images.
2. Start the application services in separate docker containers.
3. Run the test in a test container that links to the application services.
4. Stop the application services.

Packnsend commands
------------------

Packnsend comes with a help command:

    $ packnsend help

    packnsend: COMMAND [arg...]

    Run Commands:
        run      Run command on test container.
        run -i   Run command interactively
        shell    Launch a shell on test container.

    Management Commands:

    To operate on a subset of images/containers, pass a list of
    space-separated names of images to the management commands.
    Otherwise, they operate on all images/containers.

        init     Pull images, if authorized, else build.
        build    Build base images.
        push     Push base images.
        pull     Pull base images.
        start    Start base containers.
        stop     Stop base containers.
        cleanup  Delete base images.

    Help commands:
        list     List available base images.
        help     Print help message.

The various packnsend commands are described in more detail below.

Setting up base images
----------------------

To setup the required base images needed for testing run 'packnsend' with
the 'init' command:

    packnsend init

If you have a quay.io account set up, this command will pull the images from
the private docker image repository. Otherwise, this command will build the
images from the Dockerfiles.

In either case, this will take awhile.

Building the images
-------------------

If you know you want to build the images from the Dockerfiles, and not pull
them, you can run `packnsend` with the `build` command:

    packnsend build

The build command accepts a image names as arguments, if you want to build a
subset of images:

    packnsend build memcached mysql

Pulling the images from Quay.io
-------------------------------

To pull all of the images from quay.io (assuming you have set up your quay.io
account), use the `pull` command:

    packnsend pull

Pulling a subset of images is possible:

    packnsend pull squid

Pulling the images is typically faster than building them.

Pushing the images to Quay.io
-----------------------------

To update the images hosted in the quay.io repository, use the `push` command.
(Again, this requires that you have set up your quay.io account.) This command
will push all images to quay.io:

    packnsend push

To push a subset of images:

    packnsend push python-base postgresql

Running a test in docker
------------------------

Before running any tests, you first need to start up any required
application services. This is done by running:

    packnsend start

To run a command in the test docker instance you can use the 'run' command
with 'packnsend'.

    packnsend run tox -c tests/database_sqlite/tox.ini

Note that right now the output isn't streamed and will only be shown once
the command has completed. For some tests this can take up to 5 minutes.
Even more if you ran './tests.sh' from top level directory of the agent
repository.

You can actually supply any UNIX command after 'run'. The result will be
that the local HEAD of the git repository contents, including anything that
you have staged in the git index, will be copied up to the docker instance
and then the command run.

In other words, you don't have to commit changes, but you do need to have
staged them in the git index. This allows you to indicate what are the
changes without commit so commit history not polluted while iterating over
changes during testing.

The command when run will be from the same relative directory within the
source code as you were in when you can the 'packnsend' command.

Passing environment variables
-----------------------------

Certain variables that are present in your current environment will
be passed as environment variables to the test docker instance. This
allows you to configure selected settings when you run a test.

For example, to change `settings.startup_timeout`, you should set the
`NEW_RELIC_STARTUP_TIMEOUT` environment variable:

    export NEW_RELIC_STARTUP_TIMEOUT=60
    packnsend run tox -c tests/database_psycopg2/tox.ini

Only the following environment variables are passed from your environment
to the test docker instance:

    NEW_RELIC_STARTUP_TIMEOUT
    NEW_RELIC_SHUTDOWN_TIMEOUT
    NEW_RELIC_FAKE_COLLECTOR
    NEW_RELIC_PROXY_HOST
    NEW_RELIC_PROXY_PORT
    NEW_RELIC_PROXY_USER
    NEW_RELIC_PROXY_PASS

Launching a shell in docker
---------------------------

There are two different options for launching a shell in a test docker
instance.

1. Connect after a test has run.

For instance, if a test has been failing, you can launch into a shell
with the results of running the test using the '-i' option.

    packnsend run -i tox -c tests/database_sqlite/tox.ini

2. Connect without running any commands.

If you don't want to run a test and simply want a shell, use:

    packnsend shell

In all cases when a command or shell is run up in the test container, it
will be done as the UNIX user 'guest'.

Cleaning up containers
----------------------

After any command, the container and any temporary images will be cleaned
up and deleted automatically, so that the docker service doesn't fill up
with garbage.

Stopping application services
-----------------------------

When done testing, the application services can be shutdown by running:

    packnsend stop

To stop only some of the services, pass the image names to the stop command:

    packnsend stop redis mongodb

Updating images
---------------

If the base images have been changed, the way to update them is to remove the
old ones, and then create them anew.

Remove base images:

    packnsend cleanup

Or, Remove a subset of images:

    packnsend cleanup squid

Create base images:

    packnsend init

Listing images
--------------

The list command shows all base images on which packnsend can operate.

It is *NOT* a list of images that exist in the local docker repository.
Instead, it is a list of all images that packnsend knows how to pull, or
build, or push, etc.

    packnsend list
